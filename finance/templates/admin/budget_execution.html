{% extends "admin/base_site.html" %}
{% load i18n humanize static %}

{% block breadcrumbs %}
<nav aria-label="breadcrumbs">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin:index' %}">홈</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admin:monthly_report' %}?year={{ year }}&month={{ month }}">월간보고서</a></li>
        <li class="breadcrumb-item active">{{ year }}년 {{ month }}월 예산집행 내역</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<style>
    .execution-container {
        max-width: 1200px;
    }
    .execution-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .execution-header h1 {
        font-size: 22px;
        margin: 0;
    }
    .execution-header .subtitle {
        font-size: 14px;
        color: #666;
    }
    .execution-header .unit {
        font-size: 12px;
        color: #888;
    }
    .btn-row {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
    }
    .btn-row .btn {
        padding: 8px 20px;
        font-size: 13px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
    }
    .btn-row .btn-print {
        background: #28a745;
        color: white;
    }
    .btn-row .btn-secondary {
        background: #6c757d;
        color: white;
    }
    .execution-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .execution-table th, .execution-table td {
        border: 1px solid #999;
        padding: 5px 8px;
        text-align: center;
    }
    .execution-table th {
        background: #f0f0f0;
        font-weight: bold;
    }
    .execution-table .col-large { width: 60px; }
    .execution-table .col-medium { width: 90px; text-align: left; }
    .execution-table .col-item { text-align: left; }
    .execution-table .col-budget { width: 100px; text-align: right; }
    .execution-table .col-executed { width: 90px; text-align: right; }
    .execution-table .col-rate { width: 50px; }
    .execution-table .col-month { width: 90px; text-align: right; }
    .execution-table .col-remaining { width: 100px; text-align: right; }
    .execution-table .col-note { width: 120px; text-align: left; }
    .execution-table .subtotal-row {
        background: #e8f4e8;
        font-weight: bold;
    }
    .execution-table .large-total-row {
        background: #d4edda;
        font-weight: bold;
    }
    .execution-table .total-row {
        background: #c3e6cb;
        font-weight: bold;
        font-size: 13px;
    }
    .execution-table .category-cell {
        background: #f8f9fa;
        font-weight: bold;
        vertical-align: middle;
    }
    .execution-table .medium-cell {
        background: #fafafa;
        vertical-align: middle;
    }
    .execution-table .amount-negative {
        color: #dc3545;
    }
</style>

<div class="execution-container">
    <div class="execution-header">
        <div>
            <h1>{{ year }}년 {{ month }}월 예산집행 내역</h1>
            <div class="subtitle">담 당 / 국 장 / 회 장</div>
        </div>
        <div class="unit">(단위 : 원)</div>
    </div>

    <div class="btn-row">
        <a href="{% url 'admin:budget_execution_print' year=year month=month %}"
           class="btn btn-print" target="_blank">출력</a>
        <a href="{% url 'admin:monthly_report' %}?year={{ year }}&month={{ month }}"
           class="btn btn-secondary">목록</a>
    </div>

    <table class="execution-table">
        <thead>
            <tr>
                <th class="col-large" colspan="2">구 분</th>
                <th class="col-item">내 역</th>
                <th class="col-budget">연간 예산</th>
                <th class="col-executed" colspan="2">집행현황<br>누계 및 예산대비(%)</th>
                <th class="col-month">{{ month }}월 집행액</th>
                <th class="col-remaining">잔여예산</th>
                <th class="col-note">비 고</th>
            </tr>
        </thead>
        <tbody>
            {% for large_cat, large_data in execution_data.items %}
                {% for med_cat, med_data in large_data.medium_categories.items %}
                    {% for item in med_data.items %}
                    <tr>
                        {% if forloop.parentloop.first and forloop.first %}
                        <td class="col-large category-cell" rowspan="{{ large_data.row_count }}">{{ large_cat }}</td>
                        {% endif %}
                        {% if forloop.first %}
                        <td class="col-medium medium-cell" rowspan="{{ med_data.row_count }}">{{ med_cat }}</td>
                        {% endif %}
                        <td class="col-item">{{ item.display_name }}</td>
                        <td class="col-budget">{{ item.annual_budget|floatformat:0|intcomma }}</td>
                        <td class="col-executed">{% if item.cumulative %}{{ item.cumulative|floatformat:0|intcomma }}{% else %}-{% endif %}</td>
                        <td class="col-rate">{{ item.exec_rate|floatformat:0 }}%</td>
                        <td class="col-month">{% if item.monthly %}{{ item.monthly|floatformat:0|intcomma }}{% else %}-{% endif %}</td>
                        <td class="col-remaining {% if item.remaining < 0 %}amount-negative{% endif %}">{{ item.remaining|floatformat:0|intcomma }}</td>
                        <td class="col-note">{{ item.note }}</td>
                    </tr>
                    {% endfor %}
                    <!-- 중분류 소계 행 (항목이 2개 이상일 때만 표시) -->
                    {% if med_data.items|length > 1 %}
                    <tr class="subtotal-row">
                        <td class="col-item">소 계</td>
                        <td class="col-budget">{{ med_data.subtotal_budget|floatformat:0|intcomma }}</td>
                        <td class="col-executed">{{ med_data.subtotal_executed|floatformat:0|intcomma }}</td>
                        <td class="col-rate">{{ med_data.subtotal_rate|floatformat:0 }}%</td>
                        <td class="col-month">{% if med_data.subtotal_month %}{{ med_data.subtotal_month|floatformat:0|intcomma }}{% else %}-{% endif %}</td>
                        <td class="col-remaining {% if med_data.subtotal_remaining < 0 %}amount-negative{% endif %}">{{ med_data.subtotal_remaining|floatformat:0|intcomma }}</td>
                        <td class="col-note"></td>
                    </tr>
                    {% endif %}
                {% endfor %}
                <!-- 대분류 합계 행 -->
                <tr class="large-total-row">
                    <td colspan="3" style="text-align: center;">{{ large_cat }} 계</td>
                    <td class="col-budget">{{ large_data.total_budget|floatformat:0|intcomma }}</td>
                    <td class="col-executed">{{ large_data.total_executed|floatformat:0|intcomma }}</td>
                    <td class="col-rate">{{ large_data.total_rate|floatformat:0 }}%</td>
                    <td class="col-month">{% if large_data.total_month %}{{ large_data.total_month|floatformat:0|intcomma }}{% else %}-{% endif %}</td>
                    <td class="col-remaining {% if large_data.total_remaining < 0 %}amount-negative{% endif %}">{{ large_data.total_remaining|floatformat:0|intcomma }}</td>
                    <td class="col-note"></td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="9" style="text-align: center; padding: 20px; color: #888;">
                        예산 데이터가 없습니다. 먼저 계정과목등록(예산입력)에서 예산을 등록해주세요.
                    </td>
                </tr>
            {% endfor %}

            {% if execution_data %}
            <!-- 전체 합계 행 -->
            <tr class="total-row">
                <td colspan="3" style="text-align: center;">합 계</td>
                <td class="col-budget">{{ grand_total_budget|floatformat:0|intcomma }}</td>
                <td class="col-executed">{{ grand_total_executed|floatformat:0|intcomma }}</td>
                <td class="col-rate">{{ grand_total_rate|floatformat:0 }}%</td>
                <td class="col-month">{% if grand_total_month %}{{ grand_total_month|floatformat:0|intcomma }}{% else %}-{% endif %}</td>
                <td class="col-remaining {% if grand_total_remaining < 0 %}amount-negative{% endif %}">{{ grand_total_remaining|floatformat:0|intcomma }}</td>
                <td class="col-note"></td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
